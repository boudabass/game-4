<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Elsass Farm</title>

    <link rel="stylesheet" href="style.css">

    <!-- 1. LIBRAIRIES -->
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.4/lib/p5.js"></script>
    <!-- p5.sound.min.js supprim√© - non utilis√© et cause des avertissements AudioContext sur mobile -->
    <script src="https://p5play.org/v3/planck.min.js"></script>
    <script src="https://p5play.org/v3/p5play.js"></script>

    <!-- 2. SYSTEME -->
    <script>
        window.DyadGame = { id: 'elsass-farm-v1', version: 'v1' };
    </script>
    <script src="../../system/system.js"></script>

    <!-- 3. JEU -->
    <script src="config.js"></script>
    <script src="core/LoadingManager.js"></script>
    <script src="core/GameState.js"></script>
    <script src="core/TimeManager.js"></script>
    <script src="core/SaveManager.js"></script>
    <script src="systems/MinimapRenderer.js"></script>
    <script src="systems/DebugManager.js"></script>
    <script src="systems/UIManager.js"></script>
    <script src="systems/InputManager.js"></script>
    <script src="systems/GridSystem.js"></script>
    <script src="systems/Inventory.js"></script>
    <script src="systems/QuickAction.js"></script>
    <script src="main.js"></script>
    <script src="sketch.js"></script>

    <script>
        // Ponts vers UIManager (n√©cessaires pour les onclick)
        function toggleMenu() { UIManager.toggleMenu(); }
        function toggleMap() { UIManager.toggleMap(); }
        function toggleDebug() { UIManager.toggleDebug(); }
        function toggleFullscreen() { UIManager.toggleFullscreen(); }
        function toggleGrid() { UIManager.toggleGrid(); }
        function toggleInventory() { UIManager.toggleInventory(); }

        function switchInvTab(tab, event) {
            if (event) event.stopPropagation();
            // Mettre √† jour les onglets actifs
            document.querySelectorAll('.inv-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            // G√©n√©rer le contenu
            const content = document.getElementById('inv-content');
            let html = '';

            if (tab === 'seeds' && window.Inventory) {
                html += '<div class="inv-grid-seeds">';
                const seasons = {
                    'SPRING': 'ü™µ Printemps',
                    'SUMMER': '‚òÄÔ∏è √ât√©',
                    'AUTUMN': 'üçÇ Automne',
                    'WINTER': '‚ùÑÔ∏è Hiver'
                };

                for (const seasonId in seasons) {
                    html += `<div class="inv-section-title">${seasons[seasonId]}</div>`;
                    const seeds = Inventory.player.seeds[seasonId] || [];
                    const isCurrentSeason = GameState.season === seasonId;

                    seeds.forEach((seed, idx) => {
                        const isSelected = isCurrentSeason && idx === Inventory.selectedSeedIndex;
                        const isDisabled = !isCurrentSeason;

                        html += `
                        <div class="inv-slot-horizontal ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}" 
                            onclick="${isCurrentSeason ? `selectSeed(${idx}, event)` : 'event.stopPropagation()'}"
                        >
                            <div class="item-icon-small">${seed.icon || '?'}</div>
                            <div class="item-details">
                                <div class="item-name-text">${seed.name || ''}</div>
                                <div class="item-qty-text">x${seed.qty}</div>
                            </div>
                        </div>`;
                    });
                }
                html += '</div>';
            } else if (tab === 'tools' && window.Inventory) {
                html += '<div class="inv-tools-container">';
                Inventory.player.tools.forEach((tool, idx) => {
                    const isSelected = idx === Inventory.selectedToolIndex;
                    html += `
                    <div class="inv-tool-row">
                        <div class="inv-tool-icon-box ${isSelected ? 'selected' : ''}" onclick="selectTool(${idx}, event)">
                            ${tool.icon}
                        </div>
                        <div class="inv-tool-info-box">
                            <div class="inv-tool-name">${tool.name}</div>
                            <div class="inv-tool-level">${tool.level > 0 ? `Niveau ${tool.level}` : 'Non d√©bloqu√©'}</div>
                        </div>
                    </div>`;
                });
                html += '</div>';
            } else if (tab === 'loot' && window.Inventory) {
                html += '<div class="inv-grid-loot">';
                const categories = {
                    'WOOD': 'ü™µ Bois',
                    'STONE': '‚õèÔ∏è Pierre',
                    'METAL': '‚öîÔ∏è M√©tal',
                    'MACHINES': 'üè≠ Machines',
                    'NATURE': 'üåø Nature',
                    'POTIONS': 'üß™ Potions'
                };

                for (const catId in categories) {
                    html += `<div class="inv-section-title">${categories[catId]}</div>`;
                    const items = Inventory.player.loot[catId] || [];
                    items.forEach(item => {
                        html += `
                        <div class="inv-slot-horizontal" onclick="event.stopPropagation()">
                            <div class="item-icon-small">${item.icon}</div>
                            <div class="item-details">
                                <div class="item-name-text">${item.name}</div>
                                <div class="item-qty-text">x${item.qty}</div>
                            </div>
                        </div>`;
                    });
                }
                html += '</div>';
            }

            content.innerHTML = html || '<p style="text-align: center; color: #888;">Vide</p>';
        }

        function selectSeed(idx, event) {
            if (event) event.stopPropagation();
            if (Inventory) Inventory.selectSeed(idx);
            switchInvTab('seeds');
        }

        function selectTool(idx, event) {
            if (event) event.stopPropagation();
            if (Inventory) Inventory.selectTool(idx);
            switchInvTab('tools');
        }

        // Sauvegarde Locale Manuelle (pour les tests)
        function saveGame() {
            if (window.SaveManager) {
                SaveManager.save();
                alert('‚úÖ Partie sauvegard√©e en local !');
            }
        }

        // Chargement Manuel
        function loadGame() {
            if (window.SaveManager) {
                SaveManager.load();
            }
        }

        // --- Quitter le jeu : Sauvegarde CLOUD ---
        async function quitGame(event) {
            if (event) event.stopPropagation();

            // 1. Masquer l'UI
            const menuList = document.querySelector('#menu-modal .menu-list');
            if (menuList) menuList.style.display = 'none';

            // 2. UI Chargement
            const container = document.getElementById('save-loading-container');
            const bar = document.getElementById('save-progress-fill');
            const text = document.getElementById('save-status-text');

            if (container && bar) {
                container.style.display = 'block';
                if (text) text.innerText = "Synchronisation Cloud...";

                // 3. Sauvegarde Locale + Cloud
                if (typeof SaveManager !== 'undefined') {
                    // D'abord on assure le local
                    SaveManager.save();
                    // Ensuite on envoie au cloud (await pour attendre la fin)
                    await SaveManager.saveToCloud();
                }

                // 4. Animation de fin
                bar.style.width = '100%';
                if (text) text.innerText = "Termin√© !";

                setTimeout(() => {
                    document.body.innerHTML = `
                        <div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#111;color:white;flex-direction:column;font-family:sans-serif;">
                            <h1>Sauvegarde r√©ussie</h1>
                            <p>Vos donn√©es sont s√©curis√©es dans le cloud.</p>
                            <p style="color:#777;font-size:12px;margin-top:20px;">Vous pouvez fermer cet onglet.</p>
                        </div>
                    `;
                    try { window.close(); } catch (e) { }
                }, 500);
            }
        }

        // Charger automatiquement au d√©marrage
        window.addEventListener('load', function () {
            // Le chargement est maintenant g√©r√© par le LoadingManager et le SaveManager
            // On s'assure que la boucle p5.js est stopp√©e au d√©but
            if (typeof noLoop === 'function') noLoop();
            
            setTimeout(function () {
                if (typeof SaveManager !== 'undefined') {
                    SaveManager.load();
                } else {
                    console.error("‚ùå SaveManager non charg√© !");
                }
            }, 500);
        });

        // --- Fonctions de Triche (Debug) ---
        function cheatEnergy() {
            if (window.GameState) {
                GameState.restoreEnergy(50);
                if (window.refreshHUD) window.refreshHUD();
                console.log("‚ö° Cheat: +50 √ânergie");
            }
        }

        function cheatFullEnergy() {
            if (window.GameState) {
                GameState.energy = GameState.maxEnergy;
                if (window.refreshHUD) window.refreshHUD();
                console.log("‚ö° Cheat: √ânergie Max");
            }
        }

        function cheatGold() {
            if (window.GameState) {
                GameState.addGold(100);
                if (window.refreshHUD) window.refreshHUD();
                console.log("üí∞ Cheat: +100 Or");
            }
        }

        function cheatSeeds() {
            if (window.Inventory) {
                const seeds = Inventory.getCurrentSeasonSeeds();
                seeds.forEach(seed => {
                    if (seed.id.indexOf('empty') === -1) {
                        seed.qty += 10;
                    }
                });
                console.log("üå± Cheat: +10 de chaque graine de saison");
                const invModal = document.getElementById('inventory-modal');
                if (invModal.classList.contains('active')) {
                    switchInvTab('seeds');
                }
            }
        }
    </script>
</head>

<body>
    <!-- √âcran de Chargement (Masque tout le reste au d√©but) -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <h1>Elsass Farm</h1>
            
            <!-- Conteneur pour l'historique des messages -->
            <div id="loading-history" class="loading-history">
                <!-- Les messages de progression seront ajout√©s ici -->
            </div>

            <div id="loading-bar-container" class="loading-bar-container">
                <!-- Le statut actuel est maintenant dans l'historique -->
                <div class="save-progress-track">
                    <div class="save-progress-fill" id="loading-progress-fill"></div>
                </div>
            </div>
            
            <!-- Le bouton est maintenant sous la barre -->
            <button id="play-button" class="hud-btn" style="display: none; margin-top: 20px;">JOUER</button>
        </div>
    </div>

    <!-- UI Layer -->
    <div id="ui-layer">
        <div class="hud-bar">
            <div class="hud-group">
                <span>‚ö° <span id="val-energy">100</span></span>
                <span>üí∞ <span id="val-gold">0</span></span>
            </div>
            <div class="hud-group">
                <span>üåÖ J<span id="val-day">1</span> <span id="val-time">6:00</span></span>
            </div>
            <div class="hud-group">
                <button class="hud-btn" onclick="event.stopPropagation(); toggleInventory()">üì¶ INV</button>
                <button class="hud-btn" onclick="event.stopPropagation(); toggleMap()">üó∫Ô∏è MAP</button>
                <button class="hud-btn" onclick="event.stopPropagation(); toggleMenu()">‚â° MENU</button>
            </div>
        </div>

        <!-- Menu Principal Modal -->
        <div id="menu-modal" class="modal-overlay" onclick="if(event.target.id === 'menu-modal') toggleMenu()">
            <div class="modal-content">
                <h3>PAUSE</h3>
                <div class="menu-list">
                    <button class="hud-btn" onclick="toggleFullscreen()">‚õ∂ Plein √âcran</button>
                    <button class="hud-btn" onclick="quitGame(event)">üíæ Quitter & Sauvegarder</button>
                    <button class="hud-btn" onclick="toggleDebug()">üêõ Debug Info</button>
                    <button class="hud-btn" onclick="toggleMenu()">Reprendre</button>
                </div>

                <!-- Barre de chargement sauvegarde -->
                <div id="save-loading-container">
                    <div class="save-status-text" id="save-status-text">Sauvegarde en cours...</div>
                    <div class="save-progress-track">
                        <div class="save-progress-fill" id="save-progress-fill"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mini-Map Modal -->
        <div id="map-modal" class="modal-overlay" onclick="if(event.target.id === 'map-modal') toggleMap()">
            <div class="modal-content">
                <h3 style="color: white;">Carte de Elsas Farm</h3>
                <div id="minimap-grid" class="minimap-grid">
                    <!-- Tiles g√©n√©r√©es par JS -->
                </div>
            </div>
        </div>

        <!-- Debug Modal -->
        <div id="debug-modal" class="modal-overlay" onclick="if(event.target.id === 'debug-modal') toggleDebug()">
            <div class="modal-content"
                style="max-width: 500px; text-align: left; height: 80vh; overflow: hidden; display: flex; flex-direction: column;">

                <!-- ENTETE DEBUG -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #7f8c8d; padding-bottom: 10px; margin-bottom: 10px;">
                    <h3 style="margin: 0; color: #e74c3c;">üêõ Debug Console</h3>
                    <button class="hud-btn hud-btn-red" onclick="toggleDebug()"
                        style="padding: 4px 8px; font-size: 12px;">X</button>
                </div>

                <!-- ONGLETS -->
                <div class="debug-tabs" style="display: flex; gap: 5px; margin-bottom: 10px;">
                    <button class="hud-btn active" id="tab-general"
                        onclick="DebugManager.switchTab('general')">G√©n√©ral</button>
                    <button class="hud-btn" id="tab-time" onclick="DebugManager.switchTab('time')">Temps</button>
                    <button class="hud-btn" id="tab-farming"
                        onclick="DebugManager.switchTab('farming')">Farming</button>
                    <button class="hud-btn" id="tab-inv" onclick="DebugManager.switchTab('inv')">Inventaire</button>
                </div>

                <!-- CONTENU SCROLLABLE -->
                <div id="debug-panels" style="flex: 1; overflow-y: auto; padding-right: 5px;">

                    <!-- PANNEAU GENERAL -->
                    <div id="panel-general" class="debug-panel">
                        <button class="hud-btn" id="toggle-grid-btn" onclick="toggleGrid()"
                            style="width: 100%; margin-bottom: 10px;">Toggle Grid (ON)</button>
                        <div id="debug-content"
                            style="font-family: monospace; font-size: 12px; background: #000; padding: 10px; border-radius: 4px; color: #2ecc71;">
                            <!-- Info temps r√©el -->
                        </div>
                    </div>

                    <!-- PANNEAU TEMPS -->
                    <div id="panel-time" class="debug-panel" style="display: none;">
                        <h4 style="margin: 5px 0; color: #f39c12;">Temps Actuel</h4>
                        <div style="background: #2c3e50; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                            <span id="dbg-time-display">J1 - 06:00 - SPRING</span>
                        </div>

                        <h4 style="margin: 10px 0;">Contr√¥les</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <button class="hud-btn" onclick="DebugManager.action('addHour')">+1 Heure</button>
                            <button class="hud-btn" onclick="DebugManager.action('nextDay')">Passer la Nuit</button>
                            <button class="hud-btn" onclick="DebugManager.action('nextSeason')">Saison Suivante</button>
                        </div>
                    </div>

                    <!-- PANNEAU FARMING -->
                    <div id="panel-farming" class="debug-panel" style="display: none;">
                        <h4 style="margin: 5px 0; color: #2ecc71;">Zone Active</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <button class="hud-btn" onclick="DebugManager.action('waterAll')">üíß Arroser Tout</button>
                            <button class="hud-btn" onclick="DebugManager.action('growAll')">üå± Croissance +1</button>
                            <button class="hud-btn" onclick="DebugManager.action('instantReady')">üöú Tout Pr√™t</button>
                            <button class="hud-btn hud-btn-red" onclick="DebugManager.action('clearField')">üî• Tout
                                Raser</button>
                        </div>
                    </div>

                    <!-- PANNEAU INVENTAIRE -->
                    <div id="panel-inv" class="debug-panel" style="display: none;">
                        <h4 style="margin: 5px 0; color: #3498db;">Ressources</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <button class="hud-btn" onclick="DebugManager.action('addSeeds')">üì¶ +10 Graines</button>
                            <button class="hud-btn" onclick="DebugManager.action('addGold')">üí∞ +1000 Or</button>
                            <button class="hud-btn" onclick="DebugManager.action('maxEnergy')">‚ö° Max √ânergie</button>
                            <button class="hud-btn hud-btn-red" onclick="DebugManager.action('clearInv')">üóëÔ∏è Vider
                                Tout</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Inventory Modal -->
        <div id="inventory-modal" class="modal-overlay"
            onclick="if(event.target.id === 'inventory-modal') toggleInventory()">
            <div class="modal-content" onmousedown="event.stopPropagation()" onclick="event.stopPropagation()">

                <!-- En-t√™te : Titre + Onglets sur la m√™me ligne -->
                <div class="inv-header">
                    <div class="inv-header-title">üì¶ Inventaire</div>
                    <div class="inv-tabs">
                        <!-- Renommage Graines -> Plantes -->
                        <button class="hud-btn inv-tab active" data-tab="seeds"
                            onclick="switchInvTab('seeds', event)">üå± Plantes</button>
                        <button class="hud-btn inv-tab" data-tab="tools" onclick="switchInvTab('tools', event)">‚öôÔ∏è
                            Outils</button>
                        <button class="hud-btn inv-tab" data-tab="loot" onclick="switchInvTab('loot', event)">üß∫
                            Loot</button>
                    </div>
                </div>

                <!-- Contenu onglets -->
                <div id="inv-content"
                    style="min-height: 200px; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; padding-bottom: 20px;">
                    <!-- G√©n√©r√© par JS -->
                </div>

                <button class="hud-btn hud-btn-red" onclick="toggleInventory()"
                    style="margin-top: 15px; width: 100%; padding: 10px;">Fermer</button>
            </div>
        </div>

        <!-- Raccourcis UI (√âtape 3 - Refactoris√©) -->
        <div id="sc-seeds" class="shortcut-zone sc-left sc-empty">
            <div class="sc-circle" id="sc-seed-circle" onclick="QuickAction.handleMainClick('seeds')">
                <span class="sc-icon" id="sc-seed-icon">üå±</span>
                <div class="sc-dot sc-info" id="sc-seed-qty">0</div>
                <div class="sc-dot sc-cross" id="sc-seed-deselect"
                    onclick="event.stopPropagation(); QuickAction.deselect('seed')">‚ùå</div>
            </div>
        </div>

        <div id="sc-tools" class="shortcut-zone sc-right sc-empty">
            <div class="sc-circle" id="sc-tool-circle" onclick="QuickAction.handleMainClick('tools')">
                <span class="sc-icon" id="sc-tool-icon">‚õèÔ∏è</span>
                <div class="sc-dot sc-info" id="sc-tool-lv">Lv1</div>
                <div class="sc-dot sc-cross" id="sc-tool-deselect"
                    onclick="event.stopPropagation(); QuickAction.deselect('tool')">‚ùå</div>
            </div>
        </div>

        <!-- Barre de zoom mobile (en bas) -->
        <div id="zoom-controls" class="zoom-controls">
            <button class="zoom-btn" onclick="event.stopPropagation(); zoomOut()" title="D√©zoomer">‚ûñ</button>
            <span class="zoom-indicator" id="zoom-value">100%</span>
            <button class="zoom-btn" onclick="event.stopPropagation(); zoomIn()" title="Zoomer">‚ûï</button>
        </div>
    </div>

    <script>
        // Fonctions de zoom pour mobile
        function zoomIn() {
            if (typeof camera !== 'undefined') {
                camera.zoom *= 1.2;
                camera.zoom = constrain(camera.zoom, Config.zoom.min, Config.zoom.max);
                updateZoomDisplay();
            }
        }

        function zoomOut() {
            if (typeof camera !== 'undefined') {
                camera.zoom /= 1.2;
                camera.zoom = constrain(camera.zoom, Config.zoom.min, Config.zoom.max);
                updateZoomDisplay();
            }
        }

        function updateZoomDisplay() {
            const zoomDisplay = document.getElementById('zoom-value');
            if (zoomDisplay && typeof camera !== 'undefined') {
                zoomDisplay.textContent = Math.round(camera.zoom * 100) + '%';
            }
        }

        // Mettre √† jour l'affichage du zoom p√©riodiquement
        setInterval(updateZoomDisplay, 500);
    </script>
</body>

</html>